<html>
    <head>
        <meta charset="UTF-8">
        <title>Prolog BFS</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="/assets/css/style.css">
        
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        
        <script src="/build/prolog_bfs.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script> <!-- https://github.com/js-cookie/js-cookie-->
        <script src="https://pagecdn.io/lib/ace/1.4.5/ace.js" type="text/javascript" charset="utf-8"></script> <!-- editor -->
        <script src="/assets/js/hotkeys.min.js"></script>

	<script>
            // Config
            // save current program and query every x milliseconds
            var autosaveInterval = 60000;
            
            // how long to store the autosaved code in a cookie; in days
            var autosaveCookieLifetime = 7;
            
            // show error alert for x milliseconds
            var errorAlertDisplayDuration = 10000;
            
            // End of config
            
            /**
             * Used to indicate whether the wasm runtime is initialized
             * and ready to use. Initialization is done in the background
             * automatically.
             * @type Boolean true if the runtime is initialized
             */
            var runtimeInitialized = false;
            
            /**
             * Array holding all instances of prolog bfs.
             * The "instanceid" is the key of the instance in this array.
             * @TODO: automatically delete old instances to save resources.
             */
            var instances = [];
            
            /*
             * Before an instance of prolog bfs can be created,
             * we need to be sure the runtime is initialized.
             */
            Module['onRuntimeInitialized'] = function() {
                    runtimeInitialized = true;
            };
            
            /**
             * Scroll to the bottom in the results container. Useful after
             * results were pushed.
             */
            function scrollResultsToBottom() {
                var theDiv = document.getElementById("results_container");
                theDiv.scrollTop = theDiv.scrollHeight;
            }
            
            /**
             * Show an alert to the user with the error message.
             * Hides automatically.
             * There can only be one error alert at a time
             * @param string Error message
             */
            function showError(errortext) {
                document.getElementById("errorbox-text").textContent = errortext;
                document.getElementById("errorbox").style.display = "block";
                
                // automatically hide
                setTimeout(function() {
                    hideError();
                }, errorAlertDisplayDuration);
            }
            
            /**
             * Hide an error previously shown by showError
             */
            function hideError() {
                document.getElementById("errorbox").style.display = "none";
            }
            
            /*
             * Append another result to an existing result div
             */
            function appendResult(instanceid, result) {
                var results = document.getElementById("resultlist_" + instanceid);
                var newchild = document.createElement('p');
                newchild.innerHTML = result;
                results.appendChild(newchild);
            }
            
            /*
             * Creates a new Result div on the right column that
             * contains the query as the header and one result.
             * More results may be appended using appendResult.
             */
            function pushResult(instanceid, query, result) {
                var theDiv = document.getElementById("results_container");
                
                theDiv.innerHTML +=
                    '<div class="alert alert-secondary alert-dismissible fade show resultalert code" role="alert" id="resultalert_'+instanceid+'">'
                    + '?- ' + query
                    + '<hr>\
                       <div id="resultlist_' + instanceid + '">\
                       </div>'
                    + ' <button type="button" class="close" aria-label="Close" onclick="popResult(' + instanceid + ')"> \
                            <span aria-hidden="true">&times;</span> \
                        </button> \
                        <button type="button" class="btn btn-light btn-sm" onclick="nextAnswer(' + instanceid + ')">Next</button> \
                    </div>';
                
                appendResult(instanceid, result);
                
                /**
                * The results are appended to the bottom. User wants to
                * see the newest results always, so we instruct the browser
                * to go down to the newest result.
                */
                scrollResultsToBottom();
            }
            
            /*
             * Remove a result-alert (the container it's in)
             * from the list and kill the instance behind it.
             */
            function popResult(instanceid) {
                killInstance(instanceid);
                document.getElementById('resultalert_' + instanceid).remove();
            }
            
            /*
             * Get the next answer. Requires a program and query to
             * be loaded first.
             */
            function getAnswer(instanceid) {
                try {
                    var result = instances[instanceid].getAnswer();
                } catch(err) {
                    showError("Error getting result. Probably ran out of memory (infinite loop).");
                    console.log(err);
                    killInstance(instanceid);
                }
                
                return result;
            }
            
            /**
             * Kill an instance created by execute()
             * @param int instanceid as generated by execute()
             */
            function killInstance(instanceid) {
                if (!instances[instanceid]) { // already killed
                    return;
                }
                instances[instanceid].clear();
                instances[instanceid] = false;
            }
            
            function validateProgram(instanceid, program) {
                try {
                    error = instances[instanceid].validateProgramCode(program);
                    if (error != "") {
                        showError(error);
                    }
                } catch(e) {
                    console.log("Exception caught while validating a program. This shouldn't happen." + e);
                    return false;
                }
                return true;
            }
            
            /*
             * onclick event of the "run" button.
             * This processes the current program and query input
             * and displays the result.
             */
            function execute() {
                if (runtimeInitialized === false) {
                    alert("Please wait until Prolog BFS is loaded and try again. This might take a second.");
                }
                
                // create new instance and store it globally
                instances.push(new Module.PrologBFSWasmWrapper());
                var instanceid = instances.length-1;
                
                var inputProgram  = ace.edit("program").getValue();
                var inputQuery  = ace.edit("query").getValue();
                
                if (!inputProgram || !inputQuery) {
                    // nothing to do
                    return;
                }
                
                // check program syntax prior to actually loading
                if (!validateProgram(instanceid, inputProgram)) {
                    return; // bail out if program doesn't validate
                }
                
                //load program to the interpreter
                try {
                    instances[instanceid].loadProgram(inputProgram);
                } catch(err) {
                    showError("Error while loading program. Most likely a syntax problem.");
                    return;
                }
                // load query
                try {
                    instances[instanceid].loadQuery(inputQuery);
                } catch(err) {
                    showError("Error while loading query. Most likely a syntax problem.");
                    return;
                }
                
                // get answer
                var result = getAnswer(instanceid);
                
                pushResult(instanceid, inputQuery, result);
            }
            
            /*
             * onclick event of the "next" button.
             * Gets the next answer from the interpreter
             * and displays it.
             */
            function nextAnswer(instanceid) {
                appendResult(instanceid, getAnswer(instanceid));
                scrollResultsToBottom();
            }
            
            /**
             * Automatically store the program code to prevent
             * data loss when the browser crashes.
             */
            function autosave() {
                // Store program code for autosaveCookieLifetime days
                Cookies.set('programcode', ace.edit("program").getValue(), { expires:  autosaveCookieLifetime });
                Cookies.set('querycode', ace.edit("query").getValue(), { expires: autosaveCookieLifetime });
            }
            
            /*
             * Before browser/tab is closed, autosave
             */
            window.onbeforeunload = function() {
                autosave();
            };
            
            /*
             * Call autosave every autosaveInterval seconds
             */
            setInterval(function() {
                autosave();
            }, autosaveInterval);
            
            /*
             * register hotkeys for use *outside the editors*.
             * Unfortunately ace editor overwrites it or something,
             * so the same hotkeys must be defined again for ace.
             */
            hotkeys('ctrl+enter', 
            function(event,handler) {
                switch(handler.key) {
                    case "ctrl+enter": execute(); break;
                }
            });
		
	</script>
    </head>
    <body>
        
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="#">Prolog BFS</a>
            
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="modal" data-target="#modal_limitations" href="#"><strong>Limitations</strong></a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/LhKipp/Prolog_BFS/issues" target="_blank">Report bug</a>
                    </li>
                </ul>
            </div>
        </nav>
        
        <div class="" style="height: 90%; display: flex;">
            <!-- program editor -->
            <div class="editor bfs-container" style="flex: 1;" id="program"></div>

            <div class="bfs-container" style="display: flex; flex-flow: column; flex: 1;">
                <div class="bfs-container" style="max-height: 80%; height:80%; overflow: auto;
                    /*display: flex; flex-flow: column; justify-content: flex-end;*/" id="results_container"></div>

                <div class="bfs-container" style="display: flex; flex-flow: column; flex:1;">
                    <!-- query editor -->
                    <div class="editor" style="flex:1;" id="query"></div>
                    <button type="button" class="btn btn-primary btn-sm" onclick="execute()">Run!</button>
                </div>
            </div>
        </div>
        
        <!-- errorbox on the top right for syntax errors etc. -->
        <div class="alert alert-danger alert-dismissible" id="errorbox">
            <button type="button" class="close" onclick="hideError()">&times;</button>
            <span id="errorbox-text"></span>
        </div>
        
        <!-- infobox -->
        <div class="modal fade" id="modal_limitations" tabindex="-1" role="dialog" aria-labelledby="Usage" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Known limitations</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>This is a very limited subset of Prolog! Especially because there is no advanced error handling, this is important to know:</p>
                        <ul>
                            <li>
                                There is <strong>no syntax checker</strong> for the program. Passing syntacticaly
                                wrong code to the bfs-interpreter may cause undefined behaviour.
                                It is recommended to let your code be checked by an external tool before
                                passing it to the bfs-interpreter. You might even get <strong>false results without
                                any notice!</strong> This also applies to the points below.
                            </li>
                            <li>
                                Any kind of <strong>arithmetic is not supported</strong>. Use o for 0, s(o) for 1, s(s(o)) for 2, ...
                            </li>
                            <li>
                                Variables / constant names <strong>starting</strong> with an <strong>underscore</strong>
                                are <strong>not supported</strong>. They must only contain characters of the english alphabet.
                            </li>
                            <li>
                                There are <strong>no built-in predicates</strong>.
                            </li>
                            <li>
                                The memory limit is 500MB. If that is not enough, you might want to check out
                                the offline version on Github. You may free some memory by closing results.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            var hotkey_execute = {
                name: 'execute',
                bindKey: {win: 'Ctrl-Enter',  mac: 'Command-Enter'},
                exec: execute
            };
            
            // setting up the editors
            var ace_program = ace.edit("program");
            ace_program.setTheme("ace/theme/dreamweaver"); // textmate, dreamweaver
            ace_program.session.setMode("ace/mode/prolog");
            ace_program.setShowPrintMargin(false); // don't show the vertical line
            ace_program.commands.addCommand(hotkey_execute);
            if (Cookies.get("programcode")) { // only setValue when cookie exists
                ace_program.setValue(Cookies.get("programcode"));
            }
            
            var ace_query = ace.edit("query");
            ace_query.setTheme("ace/theme/dreamweaver");
            ace_query.session.setMode("ace/mode/prolog");
            ace_query.setShowPrintMargin(false);
            ace_query.commands.addCommand(hotkey_execute);
            if (Cookies.get("querycode")) {
                ace_query.setValue(Cookies.get("querycode"));
            }
        </script>
    </body>
</html>
