<html>
    <head>
        <meta charset="UTF-8">
        <title>Prolog BFS</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="web/style.css">
        
        <link rel="stylesheet" href="web/codemirror/codemirror.css">
        
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        
        <script src="prolog_bfs.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script> <!-- https://github.com/js-cookie/js-cookie-->
        <script src="https://pagecdn.io/lib/ace/1.4.5/ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="web/hotkeys.min.js"></script>

	<script>
            // set to true once the wasm runtime is ready.
            var runtimeInitialized = false;
            
            /*
             * Array holding all instances of prolog bfs.
             * The "instanceid" is the key of the instance in this array.
             * @TODO: automatically deleted old instances to save resources.
             */
            var instances = [];
            
            /*
             * Before an instance of prolog bfs can be created,
             * we need to be sure the runtime is initialized.
             */
            Module['onRuntimeInitialized'] = function() {
                    runtimeInitialized = true;
            };
            
            function scrollResultsToBottom() {
                var theDiv = document.getElementById("results_container");
                theDiv.scrollTop = theDiv.scrollHeight;
            }
            
            function showError(errortext) {
                document.getElementById("errorbox-text").textContent = errortext;
                document.getElementById("errorbox").style.display = "block";
                
                // automatically hide
                setTimeout(function() {
                    hideError();
                }, 5000);
            }
            
            function hideError() {
                document.getElementById("errorbox").style.display = "none";
            }
            
            /*
             * Append another result to an existin Result div
             */
            function appendResult(instanceid, result) {
                var results = document.getElementById("resultlist_" + instanceid);
                var newchild = document.createElement('p');
                newchild.innerHTML = result;
                results.appendChild(newchild);
            }
            
            /*
             * Creates a new Result div on the right column that
             * contains the query as the header and one result.
             * More results may be appended using appendResult.
             */
            function pushResult(instanceid, query, result) {
                var theDiv = document.getElementById("results_container");
                
                theDiv.innerHTML +=
                    '<div class="alert alert-secondary alert-dismissible fade show resultalert code" role="alert" id="resultalert_'+instanceid+'">'
                    + '?- ' + query
                    + '<hr>\
                       <div id="resultlist_' + instanceid + '">\
                       </div>'
                    + ' <button type="button" class="close" data-dismiss="alert" aria-label="Close" onclick> \
                            <span aria-hidden="true">&times;</span> \
                        </button> \
                        <button type="button" class="btn btn-light btn-sm" onclick="nextAnswer(' + instanceid + ')">Next</button> \
                    </div>';
                
                appendResult(instanceid, result);
                scrollResultsToBottom();
            }
            
            /*
             * onclick event of the "run" button.
             * This processes the current program and query input
             * and displays the result.
             */
            function execute() {
                if (runtimeInitialized === false) {
                    alert("Please wait until Prolog BFS is loaded and try again. This might take a second.");
                }
                
                // create new instance and store it globally
                instances.push(new Module.PrologBFSWasmWrapper());
                var instanceid = instances.length-1;
                
                var inputProgram  = ace.edit("program").getValue();
                var inputQuery  = ace.edit("query").getValue();
                
                if (!inputProgram || !inputQuery) {
                    // nothing to do
                    return;
                }
                
                //load program to the interpreter
                try {
                    instances[instanceid].loadProgram(inputProgram);
                } catch(err) {
                    showError("Error while loading program. Most likely a syntax problem.");
                    return;
                }
                // load query
                try {
                    instances[instanceid].loadQuery(inputQuery);
                } catch(err) {
                    showError("Error while loading query. Most likely a syntax problem.");
                    return;
                }
                
                // get answer
                var result = instances[instanceid].getAnswer();
                
                pushResult(instanceid, inputQuery, result);
            }
            
            /*
             * onclick event of the "next" button.
             * Gets the next answer from the interpreter
             * and displays it.
             */
            function nextAnswer(instanceid) {
                appendResult(instanceid, instances[instanceid].getAnswer());
                scrollResultsToBottom();
            }
            
            window.onbeforeunload = function() {
                // Store program code for 7 days
                Cookies.set('programcode', ace.edit("program").getValue(), { expires: 7 });
                Cookies.set('querycode', ace.edit("query").getValue(), { expires: 7 });
              };
            
            /*
             * register hotkeys for use outside the editors.
             * Unfortunately ace editor overwrites it or something,
             * so the same hotkeys must be defined again for ace.
             */
            hotkeys('ctrl+enter', 
            function(event,handler) {
                switch(handler.key) {
                    case "ctrl+enter": execute(); break;
                }
            });
		
	</script>
    </head>
    <body>
        
        <nav class="navbar navbar-light bg-light">
            <a class="navbar-brand">Prolog BFS</a>
        </nav>
	<!--<div id="content" class="container-fluid">-->
            <div class="" style="height: 90%; display: flex;">
                <!-- program editor -->
                <div class="editor bfs-container" style="flex: 1;" id="program"></div>

                <div class="bfs-container" style="display: flex; flex-flow: column; flex: 1;">
                    <div class="bfs-container" style="max-height: 80%; height:80%; overflow: auto;
                        display: flex; flex-flow: column; justify-content: flex-end;" id="results_container"></div>

                    <div class="bfs-container" style="display: flex; flex-flow: column; flex:1;">
                        <!-- query editor -->
                        <div class="editor" style="flex:1;" id="query"></div>
                        <button type="button" class="btn btn-primary btn-sm" onclick="execute()">Run!</button>
                    </div>
                </div>
            </div>
        <!--</div>-->
        
        <div class="alert alert-danger alert-dismissible" id="errorbox">
            <button type="button" class="close" onclick="hideError()">&times;</button>
            <span id="errorbox-text"></span>
        </div>
    
        <script>
            var hotkey_execute = {
                name: 'execute',
                bindKey: {win: 'Ctrl-Enter',  mac: 'Command-Enter'},
                exec: execute
            };
            
            // setting up the editors
            var ace_program = ace.edit("program");
            ace_program.setTheme("ace/theme/textmate");
            ace_program.session.setMode("ace/mode/prolog");
            ace_program.setShowPrintMargin(false); // don't show the vertical line
            ace_program.commands.addCommand(hotkey_execute);
            ace_program.setValue(Cookies.get("programcode"));
            
            var ace_query = ace.edit("query");
            ace_query.setTheme("ace/theme/textmate");
            ace_query.session.setMode("ace/mode/prolog");
            ace_query.setShowPrintMargin(false);
            ace_query.commands.addCommand(hotkey_execute);
            ace_query.setValue(Cookies.get("querycode"));
        </script>
    </body>
</html>
